#!/usr/bin/env python3
"""
漏洞分類器
對掃描結果進行分類和評分
"""

import logging
from typing import Dict, Any

logger = logging.getLogger(__name__)

class VulnerabilityClassifier:
    """漏洞分類和評分器"""

    def __init__(self):
        self.severity_weights = {
            'critical': 10.0,
            'high': 7.5,
            'medium': 5.0,
            'low': 2.5,
            'info': 1.0
        }

        self.confidence_multipliers = {
            'confirmed': 1.0,
            'likely': 0.8,
            'possible': 0.6,
            'false_positive': 0.0
        }

    async def classify(self, vulnerability) -> Any:
        """分類和評分漏洞"""
        try:
            # 基於 CWE ID 調整嚴重程度
            enhanced_severity = self._enhance_severity_by_cwe(
                vulnerability.severity,
                vulnerability.cwe_id
            )

            # 基於 OWASP 類別調整
            enhanced_severity = self._enhance_severity_by_owasp(
                enhanced_severity,
                vulnerability.owasp_category
            )

            # 計算風險評分
            risk_score = self._calculate_risk_score(
                enhanced_severity,
                vulnerability.confidence
            )

            # 更新漏洞物件
            vulnerability.severity = enhanced_severity
            vulnerability.risk_score = risk_score

            return vulnerability

        except Exception as e:
            logger.error(f"漏洞分類錯誤: {str(e)}")
            return vulnerability

    def _enhance_severity_by_cwe(self, current_severity: str, cwe_id: str) -> str:
        """基於 CWE ID 增強嚴重程度"""
        critical_cwes = [
            'CWE-89',   # SQL Injection
            'CWE-78',   # Command Injection
            'CWE-94',   # Code Injection
            'CWE-502'   # Deserialization
        ]

        high_cwes = [
            'CWE-79',   # XSS
            'CWE-352',  # CSRF
            'CWE-22',   # Path Traversal
            'CWE-434'   # File Upload
        ]

        if cwe_id in critical_cwes and current_severity != 'critical':
            return 'critical'
        elif cwe_id in high_cwes and current_severity in ['medium', 'low']:
            return 'high'

        return current_severity

    def _enhance_severity_by_owasp(self, current_severity: str, owasp_category: str) -> str:
        """基於 OWASP 類別增強嚴重程度"""
        if not owasp_category:
            return current_severity

        critical_categories = [
            'A03:2021',  # Injection
            'A01:2021'   # Broken Access Control
        ]

        if any(cat in owasp_category for cat in critical_categories):
            if current_severity in ['medium', 'low']:
                return 'high'

        return current_severity

    def _calculate_risk_score(self, severity: str, confidence: str) -> float:
        """計算風險評分"""
        base_score = self.severity_weights.get(severity, 2.5)
        confidence_multiplier = self.confidence_multipliers.get(confidence, 0.6)

        risk_score = base_score * confidence_multiplier

        # 限制在 0-10 範圍內
        return min(max(risk_score, 0.0), 10.0)