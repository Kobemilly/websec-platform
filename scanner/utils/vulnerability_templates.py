#!/usr/bin/env python3
"""
漏洞報告模板管理器
提供專業化的漏洞描述、修復建議和技術細節
"""

import json
import os
import logging
from typing import Dict, Optional

logger = logging.getLogger(__name__)

class VulnerabilityTemplateManager:
    """漏洞模板管理器"""
    
    def __init__(self):
        self.templates = {}
        self._load_templates()
    
    def _load_templates(self):
        """載入漏洞模板"""
        try:
            template_file = os.path.join(
                os.path.dirname(__file__),
                '../templates/vulnerability_templates.json'
            )
            
            if os.path.exists(template_file):
                with open(template_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    self.templates = data.get('templates', {})
                logger.info(f"已載入 {len(self.templates)} 個漏洞模板")
            else:
                logger.warning(f"模板文件不存在: {template_file}")
                self.templates = {}
                
        except Exception as e:
            logger.error(f"載入漏洞模板失敗: {e}")
            self.templates = {}
    
    def get_template(self, template_id: str) -> Optional[Dict]:
        """獲取漏洞模板"""
        return self.templates.get(template_id)
    
    def format_description(self, template_id: str, **kwargs) -> str:
        """格式化漏洞描述"""
        template = self.get_template(template_id)
        if not template:
            return ""
        
        description = template.get('description', '')
        try:
            return description.format(**kwargs)
        except KeyError:
            return description
    
    def format_remediation(self, template_id: str, **kwargs) -> str:
        """格式化修復建議"""
        template = self.get_template(template_id)
        if not template:
            return ""
        
        remediation = template.get('remediation', '')
        try:
            return remediation.format(**kwargs)
        except KeyError:
            return remediation
    
    def get_severity(self, template_id: str) -> str:
        """獲取嚴重程度"""
        template = self.get_template(template_id)
        return template.get('severity', 'medium') if template else 'medium'
    
    def get_cvss_score(self, template_id: str) -> float:
        """獲取 CVSS 評分"""
        template = self.get_template(template_id)
        return template.get('cvss_score', 5.0) if template else 5.0
    
    def get_cvss_vector(self, template_id: str) -> str:
        """獲取 CVSS 向量"""
        template = self.get_template(template_id)
        return template.get('cvss_vector', '') if template else ''
    
    def get_cwe_id(self, template_id: str) -> str:
        """獲取 CWE ID"""
        template = self.get_template(template_id)
        return template.get('cwe_id', 'CWE-0') if template else 'CWE-0'
    
    def get_owasp_category(self, template_id: str) -> str:
        """獲取 OWASP 分類"""
        template = self.get_template(template_id)
        return template.get('owasp_category', '') if template else ''
    
    def create_vulnerability_from_template(self, template_id: str, 
                                          affected_url: str,
                                          **extra_data) -> Dict:
        """從模板創建完整的漏洞報告"""
        template = self.get_template(template_id)
        if not template:
            return {}
        
        return {
            'title': template.get('title', ''),
            'description': self.format_description(template_id, 
                                                   url=affected_url, 
                                                   **extra_data),
            'remediation': self.format_remediation(template_id,
                                                   url=affected_url,
                                                   **extra_data),
            'severity': template.get('severity', 'medium'),
            'cvss_score': template.get('cvss_score', 5.0),
            'cvss_vector': template.get('cvss_vector', ''),
            'cwe_id': template.get('cwe_id', ''),
            'owasp_category': template.get('owasp_category', ''),
            'affected_url': affected_url
        }

# 全局實例
_template_manager = None

def get_template_manager() -> VulnerabilityTemplateManager:
    """獲取模板管理器單例"""
    global _template_manager
    if _template_manager is None:
        _template_manager = VulnerabilityTemplateManager()
    return _template_manager
